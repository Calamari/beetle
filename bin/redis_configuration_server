#! /usr/bin/env ruby

require "rubygems"
require "daemons"
require "optparse"
require File.expand_path("../lib/beetle", File.dirname(__FILE__))

Daemons.run_proc("redis_configuration_server", :log_output => true) do
  Beetle.config.redis_hosts = "localhost:6379, localhost:6380"

  opts = OptionParser.new 
  opts.on("-h", "--help") do
    puts opts.to_s
    exit
  end
  opts.on("-r", "--redis-servers host1:port1,host2:port2,...", String) do |val|
    Beetle.config.redis_hosts = val
  end
  opts.on("-t", "--redis-retry-timeout seconds", Integer) do |val|
    Beetle.config.redis_configuration_master_retry_timeout = val
  end
  opts.parse!


  Beetle.config.servers = "localhost:5672, localhost:5673"

  # set Beetle log level to info, less noisy than debug
  Beetle.config.logger.level = Logger::INFO

  Beetle::RedisConfigurationServer.new.start
end

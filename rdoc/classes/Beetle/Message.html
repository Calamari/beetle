<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: Beetle::Message</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">Beetle::Message</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../files/lib/beetle/message_rb.html">
                lib/beetle/message.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Object
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
Instance of class <a href="Message.html">Message</a> are created when a
scubscription callback fires. It is responsible for message deduplification
and determining if it should retry executing the message handler after a
handler has crashed. This is where the beef is.
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000024">ack!</a>&nbsp;&nbsp;
      <a href="#M000021">aquire_mutex!</a>&nbsp;&nbsp;
      <a href="#M000015">attempts</a>&nbsp;&nbsp;
      <a href="#M000017">attempts_limit_reached?</a>&nbsp;&nbsp;
      <a href="#M000012">completed!</a>&nbsp;&nbsp;
      <a href="#M000011">completed?</a>&nbsp;&nbsp;
      <a href="#M000013">delayed?</a>&nbsp;&nbsp;
      <a href="#M000022">delete_mutex!</a>&nbsp;&nbsp;
      <a href="#M000019">exceptions_limit_reached?</a>&nbsp;&nbsp;
      <a href="#M000004">expired?</a>&nbsp;&nbsp;
      <a href="#M000005">generate_uuid</a>&nbsp;&nbsp;
      <a href="#M000018">increment_exception_count!</a>&nbsp;&nbsp;
      <a href="#M000016">increment_execution_attempts!</a>&nbsp;&nbsp;
      <a href="#M000020">key_exists?</a>&nbsp;&nbsp;
      <a href="#M000003">msg_id</a>&nbsp;&nbsp;
      <a href="#M000002">new</a>&nbsp;&nbsp;
      <a href="#M000023">process</a>&nbsp;&nbsp;
      <a href="#M000006">redundant?</a>&nbsp;&nbsp;
      <a href="#M000014">set_delay!</a>&nbsp;&nbsp;
      <a href="#M000008">set_timeout!</a>&nbsp;&nbsp;
      <a href="#M000007">simple?</a>&nbsp;&nbsp;
      <a href="#M000010">timed_out!</a>&nbsp;&nbsp;
      <a href="#M000009">timed_out?</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">


    <div id="constants-list">
      <h3 class="section-bar">Constants</h3>

      <div class="name-list">
        <table summary="Constants">
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">FORMAT_VERSION</td>
          <td>=</td>
          <td class="context-item-value">1</td>
          <td width="3em">&nbsp;</td>
          <td class="context-item-desc">
current message format version

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">FLAG_REDUNDANT</td>
          <td>=</td>
          <td class="context-item-value">1</td>
          <td width="3em">&nbsp;</td>
          <td class="context-item-desc">
flag for encoding redundant messages

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">DEFAULT_TTL</td>
          <td>=</td>
          <td class="context-item-value">1.day</td>
          <td width="3em">&nbsp;</td>
          <td class="context-item-desc">
default lifetime of messages

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">DEFAULT_HANDLER_TIMEOUT</td>
          <td>=</td>
          <td class="context-item-value">300.seconds</td>
          <td width="3em">&nbsp;</td>
          <td class="context-item-desc">
forcefully abort a running handler after this many seonds. can be overriden
when registering a handler.

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">DEFAULT_HANDLER_EXECUTION_ATTEMPTS</td>
          <td>=</td>
          <td class="context-item-value">1</td>
          <td width="3em">&nbsp;</td>
          <td class="context-item-desc">
how many times we should try to run a handler before giving up

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">DEFAULT_HANDLER_EXECUTION_ATTEMPTS_DELAY</td>
          <td>=</td>
          <td class="context-item-value">10.seconds</td>
          <td width="3em">&nbsp;</td>
          <td class="context-item-desc">
how many seconds we should wait before retrying handler execution

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">DEFAULT_EXCEPTION_LIMIT</td>
          <td>=</td>
          <td class="context-item-value">0</td>
          <td width="3em">&nbsp;</td>
          <td class="context-item-desc">
how many exceptions should be tolerated before giving up

</td>
        </tr>
        </table>
      </div>
    </div>



    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">attempts_limit</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
how many times we should try to run the handler

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">data</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
message payload

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">delay</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
how long to wait before retrying the message handler

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">exception</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
exception raised by handler execution

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">exceptions_limit</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
how many exceptions we should tolerate before giving up

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">expires_at</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
unix timestamp after which the message should be considered stale

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">flags</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
flags sent with the message

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">format_version</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
the message format version of the message

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">handler_result</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
value returned by handler execution

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">header</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
the AMQP header received with the message

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">queue</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
name of the queue on which the message was received

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">server</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
server from which the message was received

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">timeout</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
how many seconds the handler is allowed to execute

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">uuid</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
the uuid of the message

</td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000005" class="method-detail">
        <a name="M000005"></a>

        <div class="method-heading">
          <a href="#M000005" class="method-signature">
          <span class="method-name">generate_uuid</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
generate uuid for publishing
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000005-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000005-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 117</span>
117:     <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">generate_uuid</span>
118:       <span class="ruby-constant">UUID4R</span><span class="ruby-operator">::</span><span class="ruby-identifier">uuid</span>(<span class="ruby-value">1</span>)
119:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000002" class="method-detail">
        <a name="M000002"></a>

        <div class="method-heading">
          <a href="#M000002" class="method-signature">
          <span class="method-name">new</span><span class="method-args">(queue, header, body, opts = {})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000002-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000002-source">
<pre>
    <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 53</span>
53:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">queue</span>, <span class="ruby-identifier">header</span>, <span class="ruby-identifier">body</span>, <span class="ruby-identifier">opts</span> = {})
54:       <span class="ruby-ivar">@queue</span>  = <span class="ruby-identifier">queue</span>
55:       <span class="ruby-ivar">@header</span> = <span class="ruby-identifier">header</span>
56:       <span class="ruby-ivar">@data</span>   = <span class="ruby-identifier">body</span>
57:       <span class="ruby-identifier">setup</span>(<span class="ruby-identifier">opts</span>)
58:       <span class="ruby-identifier">decode</span>
59:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000021" class="method-detail">
        <a name="M000021"></a>

        <div class="method-heading">
          <a href="#M000021" class="method-signature">
          <span class="method-name">aquire_mutex!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
aquire execution mutex before we run the handler (and delete it if we
can&#8216;t aquire it).
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000021-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000021-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 203</span>
203:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">aquire_mutex!</span>
204:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">mutex</span> = <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">setnx</span>(<span class="ruby-identifier">msg_id</span>, <span class="ruby-identifier">:mutex</span>, <span class="ruby-identifier">now</span>)
205:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Beetle: aquired mutex: #{msg_id}&quot;</span>
206:       <span class="ruby-keyword kw">else</span>
207:         <span class="ruby-identifier">delete_mutex!</span>
208:       <span class="ruby-keyword kw">end</span>
209:       <span class="ruby-identifier">mutex</span>
210:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000015" class="method-detail">
        <a name="M000015"></a>

        <div class="method-heading">
          <a href="#M000015" class="method-signature">
          <span class="method-name">attempts</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
how many times we already tried running the handler
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000015-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000015-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 168</span>
168:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">attempts</span>
169:       <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">msg_id</span>, <span class="ruby-identifier">:attempts</span>).<span class="ruby-identifier">to_i</span>
170:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000017" class="method-detail">
        <a name="M000017"></a>

        <div class="method-heading">
          <a href="#M000017" class="method-signature">
          <span class="method-name">attempts_limit_reached?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
whether we have already tried running the handler as often as specified
when the handler was registered
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000017-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000017-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 178</span>
178:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">attempts_limit_reached?</span>
179:       (<span class="ruby-identifier">limit</span> = <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">msg_id</span>, <span class="ruby-identifier">:attempts</span>)) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">limit</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">attempts_limit</span>
180:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000012" class="method-detail">
        <a name="M000012"></a>

        <div class="method-heading">
          <a href="#M000012" class="method-signature">
          <span class="method-name">completed!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
mark message handling complete in Redis
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000012-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000012-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 152</span>
152:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">completed!</span>
153:       <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">msg_id</span>, <span class="ruby-identifier">:status</span>, <span class="ruby-value str">&quot;completed&quot;</span>)
154:       <span class="ruby-identifier">timed_out!</span>
155:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000011" class="method-detail">
        <a name="M000011"></a>

        <div class="method-heading">
          <a href="#M000011" class="method-signature">
          <span class="method-name">completed?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
message handling <a href="Message.html#M000011">completed?</a>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000011-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000011-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 147</span>
147:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">completed?</span>
148:       <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">msg_id</span>, <span class="ruby-identifier">:status</span>) <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;completed&quot;</span>
149:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000013" class="method-detail">
        <a name="M000013"></a>

        <div class="method-heading">
          <a href="#M000013" class="method-signature">
          <span class="method-name">delayed?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
whether we should wait before running the handler
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000013-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000013-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 158</span>
158:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delayed?</span>
159:       (<span class="ruby-identifier">t</span> = <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">msg_id</span>, <span class="ruby-identifier">:delay</span>)) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">now</span>
160:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000022" class="method-detail">
        <a name="M000022"></a>

        <div class="method-heading">
          <a href="#M000022" class="method-signature">
          <span class="method-name">delete_mutex!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
delete execution mutex
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000022-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000022-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 213</span>
213:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete_mutex!</span>
214:       <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">del</span>(<span class="ruby-identifier">msg_id</span>, <span class="ruby-identifier">:mutex</span>)
215:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Beetle: deleted mutex: #{msg_id}&quot;</span>
216:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000019" class="method-detail">
        <a name="M000019"></a>

        <div class="method-heading">
          <a href="#M000019" class="method-signature">
          <span class="method-name">exceptions_limit_reached?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
whether the number of exceptions has exceeded the limit set when the
handler was registered
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000019-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000019-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 188</span>
188:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">exceptions_limit_reached?</span>
189:       <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">msg_id</span>, <span class="ruby-identifier">:exceptions</span>).<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">exceptions_limit</span>
190:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000004" class="method-detail">
        <a name="M000004"></a>

        <div class="method-heading">
          <a href="#M000004" class="method-signature">
          <span class="method-name">expired?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
a message has expired if the header expiration timestamp is msaller than
the current time
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000004-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000004-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 112</span>
112:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">expired?</span>
113:       <span class="ruby-ivar">@expires_at</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">now</span>
114:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000018" class="method-detail">
        <a name="M000018"></a>

        <div class="method-heading">
          <a href="#M000018" class="method-signature">
          <span class="method-name">increment_exception_count!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
increment number of exception occurences in Redis
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000018-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000018-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 183</span>
183:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">increment_exception_count!</span>
184:       <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">incr</span>(<span class="ruby-identifier">msg_id</span>, <span class="ruby-identifier">:exceptions</span>)
185:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000016" class="method-detail">
        <a name="M000016"></a>

        <div class="method-heading">
          <a href="#M000016" class="method-signature">
          <span class="method-name">increment_execution_attempts!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
record the fact that we are trying to run the handler
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000016-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000016-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 173</span>
173:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">increment_execution_attempts!</span>
174:       <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">incr</span>(<span class="ruby-identifier">msg_id</span>, <span class="ruby-identifier">:attempts</span>)
175:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000020" class="method-detail">
        <a name="M000020"></a>

        <div class="method-heading">
          <a href="#M000020" class="method-signature">
          <span class="method-name">key_exists?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
have we already seen this message? if not, set the status to
&quot;incomplete&quot; and store the message exipration time in Redis.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000020-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000020-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 194</span>
194:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">key_exists?</span>
195:       <span class="ruby-identifier">old_message</span> = <span class="ruby-value">0</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">msetnx</span>(<span class="ruby-identifier">msg_id</span>, <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span><span class="ruby-value str">&quot;incomplete&quot;</span>, <span class="ruby-identifier">:expires</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@expires_at</span>)
196:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old_message</span>
197:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Beetle: received duplicate message: #{msg_id} on queue: #{@queue}&quot;</span>
198:       <span class="ruby-keyword kw">end</span>
199:       <span class="ruby-identifier">old_message</span>
200:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000003" class="method-detail">
        <a name="M000003"></a>

        <div class="method-heading">
          <a href="#M000003" class="method-signature">
          <span class="method-name">msg_id</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
unique message id. used to form various Redis keys.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000003-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000003-source">
<pre>
    <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 97</span>
97:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">msg_id</span>
98:       <span class="ruby-ivar">@msg_id</span> <span class="ruby-operator">||=</span> <span class="ruby-node">&quot;msgid:#{queue}:#{uuid}&quot;</span>
99:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000023" class="method-detail">
        <a name="M000023"></a>

        <div class="method-heading">
          <a href="#M000023" class="method-signature">
          <span class="method-name">process</span><span class="method-args">(handler)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
<a href="Message.html#M000023">process</a> this message and do not allow
any exception to escape to the caller
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000023-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000023-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 219</span>
219:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">process</span>(<span class="ruby-identifier">handler</span>)
220:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Beetle: processing message #{msg_id}&quot;</span>
221:       <span class="ruby-identifier">result</span> = <span class="ruby-keyword kw">nil</span>
222:       <span class="ruby-keyword kw">begin</span>
223:         <span class="ruby-identifier">result</span> = <span class="ruby-identifier">process_internal</span>(<span class="ruby-identifier">handler</span>)
224:         <span class="ruby-identifier">handler</span>.<span class="ruby-identifier">process_exception</span>(<span class="ruby-ivar">@exception</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@exception</span>
225:         <span class="ruby-identifier">handler</span>.<span class="ruby-identifier">process_failure</span>(<span class="ruby-identifier">result</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">failure?</span>
226:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
227:         <span class="ruby-constant">Beetle</span><span class="ruby-operator">::</span><span class="ruby-identifier">reraise_expectation_errors!</span>
228:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;Beetle: exception '#{e}' during processing of message #{msg_id}&quot;</span>
229:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;Beetle: backtrace: #{e.backtrace.join(&quot;\n&quot;)}&quot;</span>
230:         <span class="ruby-identifier">result</span> = <span class="ruby-constant">RC</span><span class="ruby-operator">::</span><span class="ruby-constant">InternalError</span>
231:       <span class="ruby-keyword kw">end</span>
232:       <span class="ruby-identifier">result</span>
233:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000006" class="method-detail">
        <a name="M000006"></a>

        <div class="method-heading">
          <a href="#M000006" class="method-signature">
          <span class="method-name">redundant?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
whether the publisher has tried sending this message to two servers
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000006-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000006-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 122</span>
122:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">redundant?</span>
123:       <span class="ruby-ivar">@flags</span> <span class="ruby-operator">&amp;</span> <span class="ruby-constant">FLAG_REDUNDANT</span> <span class="ruby-operator">==</span> <span class="ruby-constant">FLAG_REDUNDANT</span>
124:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000014" class="method-detail">
        <a name="M000014"></a>

        <div class="method-heading">
          <a href="#M000014" class="method-signature">
          <span class="method-name">set_delay!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
store delay value in REdis
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000014-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000014-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 163</span>
163:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_delay!</span>
164:       <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">msg_id</span>, <span class="ruby-identifier">:delay</span>, <span class="ruby-identifier">now</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">delay</span>)
165:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000008" class="method-detail">
        <a name="M000008"></a>

        <div class="method-heading">
          <a href="#M000008" class="method-signature">
          <span class="method-name">set_timeout!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
store handler timeout timestamp into Redis
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000008-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000008-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 132</span>
132:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_timeout!</span>
133:       <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">msg_id</span>, <span class="ruby-identifier">:timeout</span>, <span class="ruby-identifier">now</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">timeout</span>)
134:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000007" class="method-detail">
        <a name="M000007"></a>

        <div class="method-heading">
          <a href="#M000007" class="method-signature">
          <span class="method-name">simple?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
whether this is a message we can <a href="Message.html#M000023">process</a>
without accessing redis
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000007-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000007-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 127</span>
127:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">simple?</span>
128:       <span class="ruby-operator">!</span><span class="ruby-identifier">redundant?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">attempts_limit</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
129:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000010" class="method-detail">
        <a name="M000010"></a>

        <div class="method-heading">
          <a href="#M000010" class="method-signature">
          <span class="method-name">timed_out!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
reset handler timeout in Redis
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000010-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000010-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 142</span>
142:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">timed_out!</span>
143:       <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">msg_id</span>, <span class="ruby-identifier">:timeout</span>, <span class="ruby-value">0</span>)
144:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000009" class="method-detail">
        <a name="M000009"></a>

        <div class="method-heading">
          <a href="#M000009" class="method-signature">
          <span class="method-name">timed_out?</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
handler timed out?
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000009-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000009-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 137</span>
137:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">timed_out?</span>
138:       (<span class="ruby-identifier">t</span> = <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">msg_id</span>, <span class="ruby-identifier">:timeout</span>)) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">now</span>
139:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Private Instance methods</h3>

      <div id="method-M000024" class="method-detail">
        <a name="M000024"></a>

        <div class="method-heading">
          <a href="#M000024" class="method-signature">
          <span class="method-name">ack!</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
ack the message for rabbit. delete all keys if we are sure this is the last
message with the given message id. if deleting the keys fails (network
problem for example), the keys will be deleted by the class method
garbage_collect_keys.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000024-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000024-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/message.rb, line 326</span>
326:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ack!</span>
327:       <span class="ruby-comment cmt">#:doc:</span>
328:       <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;Beetle: ack! for message #{msg_id}&quot;</span>
329:       <span class="ruby-identifier">header</span>.<span class="ruby-identifier">ack</span>
330:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">simple?</span> <span class="ruby-comment cmt"># simple messages don't use redis</span>
331:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">redundant?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">incr</span>(<span class="ruby-identifier">msg_id</span>, <span class="ruby-identifier">:ack_count</span>) <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
332:         <span class="ruby-ivar">@store</span>.<span class="ruby-identifier">del_keys</span>(<span class="ruby-identifier">msg_id</span>)
333:       <span class="ruby-keyword kw">end</span>
334:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>
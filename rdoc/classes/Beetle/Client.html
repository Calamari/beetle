<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: Beetle::Client</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">Beetle::Client</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../files/lib/beetle/client_rb.html">
                lib/beetle/client.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Object
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000050">configure</a>&nbsp;&nbsp;
      <a href="#M000054">listen</a>&nbsp;&nbsp;
      <a href="#M000058">load</a>&nbsp;&nbsp;
      <a href="#M000059">logger</a>&nbsp;&nbsp;
      <a href="#M000044">new</a>&nbsp;&nbsp;
      <a href="#M000051">publish</a>&nbsp;&nbsp;
      <a href="#M000053">purge</a>&nbsp;&nbsp;
      <a href="#M000047">register_binding</a>&nbsp;&nbsp;
      <a href="#M000045">register_exchange</a>&nbsp;&nbsp;
      <a href="#M000049">register_handler</a>&nbsp;&nbsp;
      <a href="#M000048">register_message</a>&nbsp;&nbsp;
      <a href="#M000046">register_queue</a>&nbsp;&nbsp;
      <a href="#M000052">rpc</a>&nbsp;&nbsp;
      <a href="#M000055">stop_listening</a>&nbsp;&nbsp;
      <a href="#M000056">stop_publishing</a>&nbsp;&nbsp;
      <a href="#M000057">trace</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">bindings</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
an options hash for the configured queue bindings

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">deduplication_store</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
the deduplication store to use for this client

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">exchanges</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
an options hash for the configured exchanges

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">messages</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
an options hash for the configured messages

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">queues</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
an options hash for the configured queues

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">servers</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
the servers available for publishing

</td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000044" class="method-detail">
        <a name="M000044"></a>

        <div class="method-heading">
          <a href="#M000044" class="method-signature">
          <span class="method-name">new</span><span class="method-args">(config = Beetle.config)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
create a fresh <a href="Client.html">Client</a> instance from a given
configuration object
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000044-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000044-source">
<pre>
    <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 22</span>
22:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">config</span> = <span class="ruby-constant">Beetle</span>.<span class="ruby-identifier">config</span>)
23:       <span class="ruby-ivar">@servers</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">servers</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/ *, */</span>)
24:       <span class="ruby-ivar">@exchanges</span> = {}
25:       <span class="ruby-ivar">@queues</span> = {}
26:       <span class="ruby-ivar">@messages</span> = {}
27:       <span class="ruby-ivar">@bindings</span> = {}
28:       <span class="ruby-ivar">@deduplication_store</span> = <span class="ruby-constant">DeduplicationStore</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">config</span>.<span class="ruby-identifier">redis_hosts</span>, <span class="ruby-identifier">config</span>.<span class="ruby-identifier">redis_db</span>)
29:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000050" class="method-detail">
        <a name="M000050"></a>

        <div class="method-heading">
          <a href="#M000050" class="method-signature">
          <span class="method-name">configure</span><span class="method-args">(options={}) {|config| ...}</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
configures exchanges, queues, messages and handlers with a common set of
options. allows one to call all register methods without the register_
prefix.
</p>
<p>
Example:
</p>
<pre>
 client.configure :exchange =&gt; :foobar do |config|
   config.queue :q1, :key =&gt; &quot;foo&quot;
   config.queue :q2, :key =&gt; &quot;bar&quot;
   config.message :foo
   config.message :bar
   config.handler :q1 { puts &quot;got foo&quot;}
   config.handler :q2 { puts &quot;got bar&quot;}
 end
</pre>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000050-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000050-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 147</span>
147:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">configure</span>(<span class="ruby-identifier">options</span>={}) <span class="ruby-comment cmt">#:yields: config</span>
148:       <span class="ruby-keyword kw">yield</span> <span class="ruby-constant">Configurator</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">self</span>, <span class="ruby-identifier">options</span>)
149:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000054" class="method-detail">
        <a name="M000054"></a>

        <div class="method-heading">
          <a href="#M000054" class="method-signature">
          <span class="method-name">listen</span><span class="method-args">(messages=self.messages.keys, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
start listening to a list of messages (default to all registered messages).
runs the given block before entering the eventmachine loop.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000054-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000054-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 176</span>
176:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">listen</span>(<span class="ruby-identifier">messages</span>=<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">messages</span>.<span class="ruby-identifier">keys</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
177:       <span class="ruby-identifier">messages</span> = <span class="ruby-identifier">messages</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:to_s</span>)
178:       <span class="ruby-identifier">messages</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnknownMessage</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;unknown message #{m}&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">messages</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>)}
179:       <span class="ruby-identifier">subscriber</span>.<span class="ruby-identifier">listen</span>(<span class="ruby-identifier">messages</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
180:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000058" class="method-detail">
        <a name="M000058"></a>

        <div class="method-heading">
          <a href="#M000058" class="method-signature">
          <span class="method-name">load</span><span class="method-args">(glob)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
evaluate the ruby files matching the given <tt>glob</tt> pattern in the
context of the client instance.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000058-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000058-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 208</span>
208:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">load</span>(<span class="ruby-identifier">glob</span>)
209:       <span class="ruby-identifier">b</span> = <span class="ruby-identifier">binding</span>
210:       <span class="ruby-constant">Dir</span>[<span class="ruby-identifier">glob</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
211:         <span class="ruby-identifier">eval</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">f</span>), <span class="ruby-identifier">b</span>, <span class="ruby-identifier">f</span>)
212:       <span class="ruby-keyword kw">end</span>
213:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000059" class="method-detail">
        <a name="M000059"></a>

        <div class="method-heading">
          <a href="#M000059" class="method-signature">
          <span class="method-name">logger</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
returns the configured Logger instance
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000059-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000059-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 216</span>
216:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">logger</span>
217:       <span class="ruby-ivar">@logger</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Beetle</span>.<span class="ruby-identifier">config</span>.<span class="ruby-identifier">logger</span>
218:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000051" class="method-detail">
        <a name="M000051"></a>

        <div class="method-heading">
          <a href="#M000051" class="method-signature">
          <span class="method-name">publish</span><span class="method-args">(message_name, data=nil, opts={})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
publishes a message. the given options hash is merged with options given on
message registration.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000051-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000051-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 152</span>
152:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">publish</span>(<span class="ruby-identifier">message_name</span>, <span class="ruby-identifier">data</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">opts</span>={})
153:       <span class="ruby-identifier">message_name</span> = <span class="ruby-identifier">message_name</span>.<span class="ruby-identifier">to_s</span>
154:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnknownMessage</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;unknown message #{message_name}&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">messages</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">message_name</span>)
155:       <span class="ruby-identifier">publisher</span>.<span class="ruby-identifier">publish</span>(<span class="ruby-identifier">message_name</span>, <span class="ruby-identifier">data</span>, <span class="ruby-identifier">opts</span>)
156:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000053" class="method-detail">
        <a name="M000053"></a>

        <div class="method-heading">
          <a href="#M000053" class="method-signature">
          <span class="method-name">purge</span><span class="method-args">(queue_name)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
purges the given queue on all configured servers
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000053-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000053-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 168</span>
168:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">purge</span>(<span class="ruby-identifier">queue_name</span>)
169:       <span class="ruby-identifier">queue_name</span> = <span class="ruby-identifier">queue_name</span>.<span class="ruby-identifier">to_s</span>
170:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnknownQueue</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;unknown queue #{queue_name}&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">queues</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">queue_name</span>)
171:       <span class="ruby-identifier">publisher</span>.<span class="ruby-identifier">purge</span>(<span class="ruby-identifier">queue_name</span>)
172:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000047" class="method-detail">
        <a name="M000047"></a>

        <div class="method-heading">
          <a href="#M000047" class="method-signature">
          <span class="method-name">register_binding</span><span class="method-args">(queue_name, options={})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
register an additional binding for an already configured queue
<em>name</em> and an <em>options</em> hash:
</p>
<dl>
<dt><tt>:exchange</tt></dt><dd>the name of the exchange this queue will be bound to (defaults to the name
of the queue)

</dd>
<dt><tt>:key</tt></dt><dd>the binding key (defaults to the name of the queue)

</dd>
</dl>
<p>
automatically registers the specified exchange if it hasn&#8216;t been
registered yet
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000047-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000047-source">
<pre>
    <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 68</span>
68:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">register_binding</span>(<span class="ruby-identifier">queue_name</span>, <span class="ruby-identifier">options</span>={})
69:       <span class="ruby-identifier">name</span> = <span class="ruby-identifier">queue_name</span>.<span class="ruby-identifier">to_s</span>
70:       <span class="ruby-identifier">opts</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">symbolize_keys</span>
71:       <span class="ruby-identifier">exchange</span> = (<span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:exchange</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">name</span>).<span class="ruby-identifier">to_s</span>
72:       <span class="ruby-identifier">key</span> = (<span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:key</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">name</span>).<span class="ruby-identifier">to_s</span>
73:       (<span class="ruby-identifier">bindings</span>[<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span> []) <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-identifier">:exchange</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">exchange</span>, <span class="ruby-identifier">:key</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">key</span>}
74:       <span class="ruby-identifier">register_exchange</span>(<span class="ruby-identifier">exchange</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">exchanges</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">exchange</span>)
75:       <span class="ruby-identifier">queues</span> = (<span class="ruby-identifier">exchanges</span>[<span class="ruby-identifier">exchange</span>][<span class="ruby-identifier">:queues</span>] <span class="ruby-operator">||=</span> [])
76:       <span class="ruby-identifier">queues</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">queues</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">name</span>)
77:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000045" class="method-detail">
        <a name="M000045"></a>

        <div class="method-heading">
          <a href="#M000045" class="method-signature">
          <span class="method-name">register_exchange</span><span class="method-args">(name, options={})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
register an exchange with the given <em>name</em> and a set of
<em>options</em>:
</p>
<dl>
<dt><tt>:type</tt></dt><dd>the type option will be overwritten and always be <tt>:topic</tt>, beetle
does not allow fanout exchanges

</dd>
<dt><tt>:durable</tt></dt><dd>the durable option will be overwritten and always be true. this is done to
ensure that exchanges are never deleted

</dd>
</dl>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000045-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000045-source">
<pre>
    <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 37</span>
37:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">register_exchange</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">options</span>={})
38:       <span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_s</span>
39:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConfigurationError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;exchange #{name} already configured&quot;</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">exchanges</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">name</span>)
40:       <span class="ruby-identifier">exchanges</span>[<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">symbolize_keys</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:topic</span>, <span class="ruby-identifier">:durable</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>)
41:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000049" class="method-detail">
        <a name="M000049"></a>

        <div class="method-heading">
          <a href="#M000049" class="method-signature">
          <span class="method-name">register_handler</span><span class="method-args">(queues, *args, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
registers a handler for a list of queues (which must have been registered
previously). The handler will be invoked when any messages arrive on the
queue.
</p>
<p>
Examples:
</p>
<pre>
  register_handler([:foo, :bar], :timeout =&gt; 10.seconds) { |message| puts &quot;received #{message}&quot; }

  on_error   = lambda{ puts &quot;something went wrong with baz&quot; }
  on_failure = lambda{ puts &quot;baz has finally failed&quot; }

  register_handler(:baz, :exceptions =&gt; 1, :errback =&gt; on_error, :failback =&gt; on_failure) { puts &quot;received baz&quot; }

  register_handler(:bar, BarHandler)
</pre>
<p>
For details on handler classes see class <a
href="Handler.html">Beetle::Handler</a>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000049-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000049-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 112</span>
112:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">register_handler</span>(<span class="ruby-identifier">queues</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
113:       <span class="ruby-identifier">queues</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">queues</span>).<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:to_s</span>)
114:       <span class="ruby-identifier">queues</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">q</span><span class="ruby-operator">|</span> <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnknownQueue</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">q</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">queues</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">q</span>)}
115:       <span class="ruby-identifier">opts</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">pop</span> <span class="ruby-operator">:</span> {}
116:       <span class="ruby-identifier">handler</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">shift</span>
117:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;too many arguments for handler registration&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">empty?</span>
118:       <span class="ruby-identifier">subscriber</span>.<span class="ruby-identifier">register_handler</span>(<span class="ruby-identifier">queues</span>, <span class="ruby-identifier">opts</span>, <span class="ruby-identifier">handler</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
119:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000048" class="method-detail">
        <a name="M000048"></a>

        <div class="method-heading">
          <a href="#M000048" class="method-signature">
          <span class="method-name">register_message</span><span class="method-args">(message_name, options={})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
register a persistent message with a given <em>name</em> and an
<em>options</em> hash:
</p>
<dl>
<dt><tt>:key</tt></dt><dd>specifies the routing key for message publishing (defaults to the name of
the message)

</dd>
<dt><tt>:ttl</tt></dt><dd>specifies the time interval after which the message will be silently
dropped (seconds). defaults to Message::DEFAULT_TTL.

</dd>
<dt><tt>:redundant</tt></dt><dd>specifies whether the message should be published redundantly (defaults to
false)

</dd>
</dl>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000048-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000048-source">
<pre>
    <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 88</span>
88:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">register_message</span>(<span class="ruby-identifier">message_name</span>, <span class="ruby-identifier">options</span>={})
89:       <span class="ruby-identifier">name</span> = <span class="ruby-identifier">message_name</span>.<span class="ruby-identifier">to_s</span>
90:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConfigurationError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;message #{name} already configured&quot;</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">messages</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">name</span>)
91:       <span class="ruby-identifier">opts</span> = {<span class="ruby-identifier">:exchange</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">name</span>, <span class="ruby-identifier">:key</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">name</span>}.<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">options</span>.<span class="ruby-identifier">symbolize_keys</span>)
92:       <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">merge!</span> <span class="ruby-identifier">:persistent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
93:       <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:exchange</span>] = <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:exchange</span>].<span class="ruby-identifier">to_s</span>
94:       <span class="ruby-identifier">messages</span>[<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">opts</span>
95:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000046" class="method-detail">
        <a name="M000046"></a>

        <div class="method-heading">
          <a href="#M000046" class="method-signature">
          <span class="method-name">register_queue</span><span class="method-args">(name, options={})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
register a durable, non passive, non auto_deleted queue with the given
<em>name</em> and an <em>options</em> hash:
</p>
<dl>
<dt><tt>:exchange</tt></dt><dd>the name of the exchange this queue will be bound to (defaults to the name
of the queue)

</dd>
<dt><tt>:key</tt></dt><dd>the binding key (defaults to the name of the queue)

</dd>
</dl>
<p>
automatically registers the specified exchange if it hasn&#8216;t been
registered yet
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000046-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000046-source">
<pre>
    <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 50</span>
50:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">register_queue</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">options</span>={})
51:       <span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_s</span>
52:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConfigurationError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;queue #{name} already configured&quot;</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">queues</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">name</span>)
53:       <span class="ruby-identifier">opts</span> = {<span class="ruby-identifier">:exchange</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">name</span>, <span class="ruby-identifier">:key</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">name</span>}.<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">options</span>.<span class="ruby-identifier">symbolize_keys</span>)
54:       <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">merge!</span> <span class="ruby-identifier">:durable</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>, <span class="ruby-identifier">:passive</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">:exclusive</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">:auto_delete</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">:amqp_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">name</span>
55:       <span class="ruby-identifier">exchange</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">:exchange</span>).<span class="ruby-identifier">to_s</span>
56:       <span class="ruby-identifier">key</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">:key</span>)
57:       <span class="ruby-identifier">queues</span>[<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">opts</span>
58:       <span class="ruby-identifier">register_binding</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">:exchange</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">exchange</span>, <span class="ruby-identifier">:key</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">key</span>)
59:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000052" class="method-detail">
        <a name="M000052"></a>

        <div class="method-heading">
          <a href="#M000052" class="method-signature">
          <span class="method-name">rpc</span><span class="method-args">(message_name, data=nil, opts={})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
sends the given message to one of the configured servers and returns the
result of running the associated handler.
</p>
<p>
unexpected behavior can ensue if the message gets routed to more than one
recipient, so be careful.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000052-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000052-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 161</span>
161:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">rpc</span>(<span class="ruby-identifier">message_name</span>, <span class="ruby-identifier">data</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">opts</span>={})
162:       <span class="ruby-identifier">message_name</span> = <span class="ruby-identifier">message_name</span>.<span class="ruby-identifier">to_s</span>
163:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnknownMessage</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;unknown message #{message_name}&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">messages</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">message_name</span>)
164:       <span class="ruby-identifier">publisher</span>.<span class="ruby-identifier">rpc</span>(<span class="ruby-identifier">message_name</span>, <span class="ruby-identifier">data</span>, <span class="ruby-identifier">opts</span>)
165:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000055" class="method-detail">
        <a name="M000055"></a>

        <div class="method-heading">
          <a href="#M000055" class="method-signature">
          <span class="method-name">stop_listening</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
stops the eventmachine loop
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000055-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000055-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 183</span>
183:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">stop_listening</span>
184:       <span class="ruby-identifier">subscriber</span>.<span class="ruby-identifier">stop!</span>
185:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000056" class="method-detail">
        <a name="M000056"></a>

        <div class="method-heading">
          <a href="#M000056" class="method-signature">
          <span class="method-name">stop_publishing</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
disconnects the publisher from all servers it&#8216;s currently connected
to
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000056-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000056-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 188</span>
188:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">stop_publishing</span>
189:       <span class="ruby-identifier">publisher</span>.<span class="ruby-identifier">stop</span>
190:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000057" class="method-detail">
        <a name="M000057"></a>

        <div class="method-heading">
          <a href="#M000057" class="method-signature">
          <span class="method-name">trace</span><span class="method-args">(&amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
traces all messages received on all queues. useful for debugging message
flow.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000057-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000057-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 193</span>
193:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">trace</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
194:       <span class="ruby-identifier">queues</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">opts</span><span class="ruby-operator">|</span>
195:         <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">merge!</span> <span class="ruby-identifier">:durable</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">:auto_delete</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>, <span class="ruby-identifier">:amqp_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">queue_name_for_tracing</span>(<span class="ruby-identifier">name</span>)
196:       <span class="ruby-keyword kw">end</span>
197:       <span class="ruby-identifier">register_handler</span>(<span class="ruby-identifier">queues</span>.<span class="ruby-identifier">keys</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">msg</span><span class="ruby-operator">|</span>
198:         <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;-----===== new message =====-----&quot;</span>
199:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;SERVER: #{msg.server}&quot;</span>
200:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;HEADER: #{msg.header.inspect}&quot;</span>
201:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;MSGID: #{msg.msg_id}&quot;</span>
202:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;DATA: #{msg.data}&quot;</span>
203:       <span class="ruby-keyword kw">end</span>
204:       <span class="ruby-identifier">subscriber</span>.<span class="ruby-identifier">listen</span>(<span class="ruby-identifier">messages</span>.<span class="ruby-identifier">keys</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
205:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>
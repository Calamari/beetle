<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: Beetle::Client</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">Beetle::Client</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../files/lib/beetle/client_rb.html">
                lib/beetle/client.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Object
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
This class provides the interface through which messaging is configured for
both message producers and consumers. It keeps references to an instance of
a <a href="Subscriber.html">Beetle::Subscriber</a>, a <a
href="Publisher.html">Beetle::Publisher</a> (both of which are instantiated
on demand), and a reference to an instance of <a
href="DeduplicationStore.html">Beetle::DeduplicationStore</a>.
</p>
<p>
<a href="Configuration.html">Configuration</a> of exchanges, queues,
messages, and message handlers is done by calls to corresponding register_
methods. Note that these methods just build up the configuration, they
don&#8216;t interact with the AMQP servers.
</p>
<p>
On the publisher side, publishing a message will ensure that the exchange
it will be sent to, and each of the queues bound to the exchange, will be
created on demand. On the subscriber side, exchanges, queues, bindings and
queue subscriptions will be created when the application calls the <a
href="Client.html#M000067">listen</a> method. An application can decide to
subscribe to only a subset of the configured queues by passing a list of
queue names to the <a href="Client.html#M000067">listen</a> method.
</p>
<p>
The net effect of this strategy is that producers and consumers can be
started in any order, so that no message is lost if message producers are
accidentally started before the corresponding consumers.
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000063">configure</a>&nbsp;&nbsp;
      <a href="#M000067">listen</a>&nbsp;&nbsp;
      <a href="#M000071">load</a>&nbsp;&nbsp;
      <a href="#M000057">new</a>&nbsp;&nbsp;
      <a href="#M000064">publish</a>&nbsp;&nbsp;
      <a href="#M000066">purge</a>&nbsp;&nbsp;
      <a href="#M000060">register_binding</a>&nbsp;&nbsp;
      <a href="#M000058">register_exchange</a>&nbsp;&nbsp;
      <a href="#M000062">register_handler</a>&nbsp;&nbsp;
      <a href="#M000061">register_message</a>&nbsp;&nbsp;
      <a href="#M000059">register_queue</a>&nbsp;&nbsp;
      <a href="#M000065">rpc</a>&nbsp;&nbsp;
      <a href="#M000068">stop_listening</a>&nbsp;&nbsp;
      <a href="#M000069">stop_publishing</a>&nbsp;&nbsp;
      <a href="#M000070">trace</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->
    <div id="includes">
      <h3 class="section-bar">Included Modules</h3>

      <div id="includes-list">
        <span class="include-name"><a href="Logging.html">Logging</a></span>
      </div>
    </div>

    <div id="section">





    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">bindings</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
an options hash for the configured queue bindings

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">config</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
accessor for the beetle configuration

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">deduplication_store</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
the deduplication store to use for this client

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">exchanges</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
an options hash for the configured exchanges

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">messages</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
an options hash for the configured messages

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">queues</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
an options hash for the configured queues

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">servers</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
the AMQP servers available for publishing

</td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000057" class="method-detail">
        <a name="M000057"></a>

        <div class="method-heading">
          <a href="#M000057" class="method-signature">
          <span class="method-name">new</span><span class="method-args">(config = Beetle.config)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
create a fresh <a href="Client.html">Client</a> instance from a given
configuration object
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000057-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000057-source">
<pre>
    <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 46</span>
46:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">config</span> = <span class="ruby-constant">Beetle</span>.<span class="ruby-identifier">config</span>)
47:       <span class="ruby-ivar">@config</span>  = <span class="ruby-identifier">config</span>
48:       <span class="ruby-ivar">@servers</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">servers</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/ *, */</span>)
49:       <span class="ruby-ivar">@exchanges</span> = {}
50:       <span class="ruby-ivar">@queues</span> = {}
51:       <span class="ruby-ivar">@messages</span> = {}
52:       <span class="ruby-ivar">@bindings</span> = {}
53:       <span class="ruby-ivar">@deduplication_store</span> = <span class="ruby-constant">DeduplicationStore</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">config</span>)
54:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000063" class="method-detail">
        <a name="M000063"></a>

        <div class="method-heading">
          <a href="#M000063" class="method-signature">
          <span class="method-name">configure</span><span class="method-args">(options={}) {|config| ...}</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
this is a convenience method to <a href="Client.html#M000063">configure</a>
exchanges, queues, messages and handlers with a common set of options.
allows one to call all register methods without the register_ prefix.
returns self.
</p>
<p>
Example:
</p>
<pre>
 client = Beetle.client.new.configure :exchange =&gt; :foobar do |config|
   config.queue :q1, :key =&gt; &quot;foo&quot;
   config.queue :q2, :key =&gt; &quot;bar&quot;
   config.message :foo
   config.message :bar
   config.handler :q1 { puts &quot;got foo&quot;}
   config.handler :q2 { puts &quot;got bar&quot;}
 end
</pre>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000063-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000063-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 159</span>
159:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">configure</span>(<span class="ruby-identifier">options</span>={}) <span class="ruby-comment cmt">#:yields: config</span>
160:       <span class="ruby-keyword kw">yield</span> <span class="ruby-constant">Configurator</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">self</span>, <span class="ruby-identifier">options</span>)
161:       <span class="ruby-keyword kw">self</span>
162:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000067" class="method-detail">
        <a name="M000067"></a>

        <div class="method-heading">
          <a href="#M000067" class="method-signature">
          <span class="method-name">listen</span><span class="method-args">(messages=self.messages.keys, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
start listening to a list of messages (default to all registered messages).
runs the given block before entering the eventmachine loop.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000067-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000067-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 189</span>
189:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">listen</span>(<span class="ruby-identifier">messages</span>=<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">messages</span>.<span class="ruby-identifier">keys</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
190:       <span class="ruby-identifier">messages</span> = <span class="ruby-identifier">messages</span>.<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:to_s</span>)
191:       <span class="ruby-identifier">messages</span>.<span class="ruby-identifier">each</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnknownMessage</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;unknown message #{m}&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">messages</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">m</span>)}
192:       <span class="ruby-identifier">subscriber</span>.<span class="ruby-identifier">listen</span>(<span class="ruby-identifier">messages</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
193:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000071" class="method-detail">
        <a name="M000071"></a>

        <div class="method-heading">
          <a href="#M000071" class="method-signature">
          <span class="method-name">load</span><span class="method-args">(glob)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
evaluate the ruby files matching the given <tt>glob</tt> pattern in the
context of the client instance.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000071-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000071-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 221</span>
221:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">load</span>(<span class="ruby-identifier">glob</span>)
222:       <span class="ruby-identifier">b</span> = <span class="ruby-identifier">binding</span>
223:       <span class="ruby-constant">Dir</span>[<span class="ruby-identifier">glob</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span>
224:         <span class="ruby-identifier">eval</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">read</span>(<span class="ruby-identifier">f</span>), <span class="ruby-identifier">b</span>, <span class="ruby-identifier">f</span>)
225:       <span class="ruby-keyword kw">end</span>
226:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000064" class="method-detail">
        <a name="M000064"></a>

        <div class="method-heading">
          <a href="#M000064" class="method-signature">
          <span class="method-name">publish</span><span class="method-args">(message_name, data=nil, opts={})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
publishes a message. the given options hash is merged with options given on
message registration.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000064-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000064-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 165</span>
165:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">publish</span>(<span class="ruby-identifier">message_name</span>, <span class="ruby-identifier">data</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">opts</span>={})
166:       <span class="ruby-identifier">message_name</span> = <span class="ruby-identifier">message_name</span>.<span class="ruby-identifier">to_s</span>
167:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnknownMessage</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;unknown message #{message_name}&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">messages</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">message_name</span>)
168:       <span class="ruby-identifier">publisher</span>.<span class="ruby-identifier">publish</span>(<span class="ruby-identifier">message_name</span>, <span class="ruby-identifier">data</span>, <span class="ruby-identifier">opts</span>)
169:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000066" class="method-detail">
        <a name="M000066"></a>

        <div class="method-heading">
          <a href="#M000066" class="method-signature">
          <span class="method-name">purge</span><span class="method-args">(queue_name)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
purges the given queue on all configured servers
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000066-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000066-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 181</span>
181:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">purge</span>(<span class="ruby-identifier">queue_name</span>)
182:       <span class="ruby-identifier">queue_name</span> = <span class="ruby-identifier">queue_name</span>.<span class="ruby-identifier">to_s</span>
183:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnknownQueue</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;unknown queue #{queue_name}&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">queues</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">queue_name</span>)
184:       <span class="ruby-identifier">publisher</span>.<span class="ruby-identifier">purge</span>(<span class="ruby-identifier">queue_name</span>)
185:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000060" class="method-detail">
        <a name="M000060"></a>

        <div class="method-heading">
          <a href="#M000060" class="method-signature">
          <span class="method-name">register_binding</span><span class="method-args">(queue_name, options={})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
register an additional binding for an already configured queue
<em>name</em> and an <em>options</em> hash:
</p>
<dl>
<dt><tt>:exchange</tt></dt><dd>the name of the exchange this queue will be bound to (defaults to the name
of the queue)

</dd>
<dt><tt>:key</tt></dt><dd>the binding key (defaults to the name of the queue)

</dd>
</dl>
<p>
automatically registers the specified exchange if it hasn&#8216;t been
registered yet
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000060-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000060-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 93</span>
 93:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">register_binding</span>(<span class="ruby-identifier">queue_name</span>, <span class="ruby-identifier">options</span>={})
 94:       <span class="ruby-identifier">name</span> = <span class="ruby-identifier">queue_name</span>.<span class="ruby-identifier">to_s</span>
 95:       <span class="ruby-identifier">opts</span> = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">symbolize_keys</span>
 96:       <span class="ruby-identifier">exchange</span> = (<span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:exchange</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">name</span>).<span class="ruby-identifier">to_s</span>
 97:       <span class="ruby-identifier">key</span> = (<span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:key</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">name</span>).<span class="ruby-identifier">to_s</span>
 98:       (<span class="ruby-identifier">bindings</span>[<span class="ruby-identifier">name</span>] <span class="ruby-operator">||=</span> []) <span class="ruby-operator">&lt;&lt;</span> {<span class="ruby-identifier">:exchange</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">exchange</span>, <span class="ruby-identifier">:key</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">key</span>}
 99:       <span class="ruby-identifier">register_exchange</span>(<span class="ruby-identifier">exchange</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">exchanges</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">exchange</span>)
100:       <span class="ruby-identifier">queues</span> = (<span class="ruby-identifier">exchanges</span>[<span class="ruby-identifier">exchange</span>][<span class="ruby-identifier">:queues</span>] <span class="ruby-operator">||=</span> [])
101:       <span class="ruby-identifier">queues</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">queues</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">name</span>)
102:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000058" class="method-detail">
        <a name="M000058"></a>

        <div class="method-heading">
          <a href="#M000058" class="method-signature">
          <span class="method-name">register_exchange</span><span class="method-args">(name, options={})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
register an exchange with the given <em>name</em> and a set of
<em>options</em>:
</p>
<dl>
<dt><tt>:type</tt></dt><dd>the type option will be overwritten and always be <tt>:topic</tt>, beetle
does not allow fanout exchanges

</dd>
<dt><tt>:durable</tt></dt><dd>the durable option will be overwritten and always be true. this is done to
ensure that exchanges are never deleted

</dd>
</dl>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000058-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000058-source">
<pre>
    <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 62</span>
62:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">register_exchange</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">options</span>={})
63:       <span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_s</span>
64:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConfigurationError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;exchange #{name} already configured&quot;</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">exchanges</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">name</span>)
65:       <span class="ruby-identifier">exchanges</span>[<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">options</span>.<span class="ruby-identifier">symbolize_keys</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:topic</span>, <span class="ruby-identifier">:durable</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>)
66:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000062" class="method-detail">
        <a name="M000062"></a>

        <div class="method-heading">
          <a href="#M000062" class="method-signature">
          <span class="method-name">register_handler</span><span class="method-args">(queues, *args, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
registers a handler for a list of queues (which must have been registered
previously). The handler will be invoked when any messages arrive on the
queue.
</p>
<p>
Examples:
</p>
<pre>
  register_handler([:foo, :bar], :timeout =&gt; 10.seconds) { |message| puts &quot;received #{message}&quot; }

  on_error   = lambda{ puts &quot;something went wrong with baz&quot; }
  on_failure = lambda{ puts &quot;baz has finally failed&quot; }

  register_handler(:baz, :exceptions =&gt; 1, :errback =&gt; on_error, :failback =&gt; on_failure) { puts &quot;received baz&quot; }

  register_handler(:bar, BarHandler)
</pre>
<p>
For details on handler classes see class <a
href="Handler.html">Beetle::Handler</a>
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000062-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000062-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 137</span>
137:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">register_handler</span>(<span class="ruby-identifier">queues</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
138:       <span class="ruby-identifier">queues</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">queues</span>).<span class="ruby-identifier">map</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:to_s</span>)
139:       <span class="ruby-identifier">queues</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">q</span><span class="ruby-operator">|</span> <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnknownQueue</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">q</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">queues</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">q</span>)}
140:       <span class="ruby-identifier">opts</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Hash</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">pop</span> <span class="ruby-operator">:</span> {}
141:       <span class="ruby-identifier">handler</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">shift</span>
142:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value str">&quot;too many arguments for handler registration&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">empty?</span>
143:       <span class="ruby-identifier">subscriber</span>.<span class="ruby-identifier">register_handler</span>(<span class="ruby-identifier">queues</span>, <span class="ruby-identifier">opts</span>, <span class="ruby-identifier">handler</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
144:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000061" class="method-detail">
        <a name="M000061"></a>

        <div class="method-heading">
          <a href="#M000061" class="method-signature">
          <span class="method-name">register_message</span><span class="method-args">(message_name, options={})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
register a persistent message with a given <em>name</em> and an
<em>options</em> hash:
</p>
<dl>
<dt><tt>:key</tt></dt><dd>specifies the routing key for message publishing (defaults to the name of
the message)

</dd>
<dt><tt>:ttl</tt></dt><dd>specifies the time interval after which the message will be silently
dropped (seconds). defaults to Message::DEFAULT_TTL.

</dd>
<dt><tt>:redundant</tt></dt><dd>specifies whether the message should be published redundantly (defaults to
false)

</dd>
</dl>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000061-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000061-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 113</span>
113:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">register_message</span>(<span class="ruby-identifier">message_name</span>, <span class="ruby-identifier">options</span>={})
114:       <span class="ruby-identifier">name</span> = <span class="ruby-identifier">message_name</span>.<span class="ruby-identifier">to_s</span>
115:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConfigurationError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;message #{name} already configured&quot;</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">messages</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">name</span>)
116:       <span class="ruby-identifier">opts</span> = {<span class="ruby-identifier">:exchange</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">name</span>, <span class="ruby-identifier">:key</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">name</span>}.<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">options</span>.<span class="ruby-identifier">symbolize_keys</span>)
117:       <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">merge!</span> <span class="ruby-identifier">:persistent</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
118:       <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:exchange</span>] = <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:exchange</span>].<span class="ruby-identifier">to_s</span>
119:       <span class="ruby-identifier">messages</span>[<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">opts</span>
120:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000059" class="method-detail">
        <a name="M000059"></a>

        <div class="method-heading">
          <a href="#M000059" class="method-signature">
          <span class="method-name">register_queue</span><span class="method-args">(name, options={})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
register a durable, non passive, non auto_deleted queue with the given
<em>name</em> and an <em>options</em> hash:
</p>
<dl>
<dt><tt>:exchange</tt></dt><dd>the name of the exchange this queue will be bound to (defaults to the name
of the queue)

</dd>
<dt><tt>:key</tt></dt><dd>the binding key (defaults to the name of the queue)

</dd>
</dl>
<p>
automatically registers the specified exchange if it hasn&#8216;t been
registered yet
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000059-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000059-source">
<pre>
    <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 75</span>
75:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">register_queue</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">options</span>={})
76:       <span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_s</span>
77:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConfigurationError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;queue #{name} already configured&quot;</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">queues</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">name</span>)
78:       <span class="ruby-identifier">opts</span> = {<span class="ruby-identifier">:exchange</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">name</span>, <span class="ruby-identifier">:key</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">name</span>, <span class="ruby-identifier">:auto_delete</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">:amqp_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">name</span>}.<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">options</span>.<span class="ruby-identifier">symbolize_keys</span>)
79:       <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">merge!</span> <span class="ruby-identifier">:durable</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>, <span class="ruby-identifier">:passive</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">:exclusive</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>
80:       <span class="ruby-identifier">exchange</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">:exchange</span>).<span class="ruby-identifier">to_s</span>
81:       <span class="ruby-identifier">key</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">:key</span>)
82:       <span class="ruby-identifier">queues</span>[<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">opts</span>
83:       <span class="ruby-identifier">register_binding</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">:exchange</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">exchange</span>, <span class="ruby-identifier">:key</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">key</span>)
84:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000065" class="method-detail">
        <a name="M000065"></a>

        <div class="method-heading">
          <a href="#M000065" class="method-signature">
          <span class="method-name">rpc</span><span class="method-args">(message_name, data=nil, opts={})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
sends the given message to one of the configured servers and returns the
result of running the associated handler.
</p>
<p>
unexpected behavior can ensue if the message gets routed to more than one
recipient, so be careful.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000065-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000065-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 174</span>
174:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">rpc</span>(<span class="ruby-identifier">message_name</span>, <span class="ruby-identifier">data</span>=<span class="ruby-keyword kw">nil</span>, <span class="ruby-identifier">opts</span>={})
175:       <span class="ruby-identifier">message_name</span> = <span class="ruby-identifier">message_name</span>.<span class="ruby-identifier">to_s</span>
176:       <span class="ruby-identifier">raise</span> <span class="ruby-constant">UnknownMessage</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;unknown message #{message_name}&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">messages</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">message_name</span>)
177:       <span class="ruby-identifier">publisher</span>.<span class="ruby-identifier">rpc</span>(<span class="ruby-identifier">message_name</span>, <span class="ruby-identifier">data</span>, <span class="ruby-identifier">opts</span>)
178:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000068" class="method-detail">
        <a name="M000068"></a>

        <div class="method-heading">
          <a href="#M000068" class="method-signature">
          <span class="method-name">stop_listening</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
stops the eventmachine loop
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000068-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000068-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 196</span>
196:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">stop_listening</span>
197:       <span class="ruby-identifier">subscriber</span>.<span class="ruby-identifier">stop!</span>
198:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000069" class="method-detail">
        <a name="M000069"></a>

        <div class="method-heading">
          <a href="#M000069" class="method-signature">
          <span class="method-name">stop_publishing</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
disconnects the publisher from all servers it&#8216;s currently connected
to
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000069-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000069-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 201</span>
201:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">stop_publishing</span>
202:       <span class="ruby-identifier">publisher</span>.<span class="ruby-identifier">stop</span>
203:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000070" class="method-detail">
        <a name="M000070"></a>

        <div class="method-heading">
          <a href="#M000070" class="method-signature">
          <span class="method-name">trace</span><span class="method-args">(messages=self.messages.keys, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
traces messages without consuming them. useful for debugging message flow.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000070-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000070-source">
<pre>
     <span class="ruby-comment cmt"># File lib/beetle/client.rb, line 206</span>
206:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">trace</span>(<span class="ruby-identifier">messages</span>=<span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">messages</span>.<span class="ruby-identifier">keys</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
207:       <span class="ruby-identifier">queues</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">opts</span><span class="ruby-operator">|</span>
208:         <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">merge!</span> <span class="ruby-identifier">:durable</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">:auto_delete</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>, <span class="ruby-identifier">:amqp_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">queue_name_for_tracing</span>(<span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:amqp_name</span>])
209:       <span class="ruby-keyword kw">end</span>
210:       <span class="ruby-identifier">register_handler</span>(<span class="ruby-identifier">queues</span>.<span class="ruby-identifier">keys</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">msg</span><span class="ruby-operator">|</span>
211:         <span class="ruby-identifier">puts</span> <span class="ruby-value str">&quot;-----===== new message =====-----&quot;</span>
212:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;SERVER: #{msg.server}&quot;</span>
213:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;HEADER: #{msg.header.inspect}&quot;</span>
214:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;MSGID: #{msg.msg_id}&quot;</span>
215:         <span class="ruby-identifier">puts</span> <span class="ruby-node">&quot;DATA: #{msg.data}&quot;</span>
216:       <span class="ruby-keyword kw">end</span>
217:       <span class="ruby-identifier">listen</span>(<span class="ruby-identifier">messages</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
218:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>